CREATE TABLE Library (
    BookID     NUMBER PRIMARY KEY,
    Title      VARCHAR2(100),
    Author     VARCHAR2(50),
    Publisher  VARCHAR2(50),
    Price      NUMBER(8,2)
);

CREATE TABLE Library_Audit (
    AuditID     NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    BookID      NUMBER,
    Title       VARCHAR2(100),
    Author      VARCHAR2(50),
    Publisher   VARCHAR2(50),
    Price       NUMBER(8,2),
    Operation   VARCHAR2(10),
    Modified_By VARCHAR2(30),
    Audit_Date  DATE DEFAULT SYSDATE
);


CREATE OR REPLACE TRIGGER trg_Library_Audit
BEFORE UPDATE OR DELETE
ON Library
FOR EACH ROW
BEGIN
    INSERT INTO Library_Audit
    (BookID, Title, Author, Publisher, Price, Operation, Modified_By, Audit_Date)
    VALUES
    (:OLD.BookID, :OLD.Title, :OLD.Author, :OLD.Publisher, :OLD.Price,
     CASE 
        WHEN UPDATING THEN 'UPDATE'
        WHEN DELETING THEN 'DELETE'
     END,
     USER,       -- Records which user performed the change
     SYSDATE);   -- Records when the change happened
END;
/
SHOW ERRORS;


INSERT INTO Library VALUES (1, 'Database Systems', 'Elmasri', 'Pearson', 550);
INSERT INTO Library VALUES (2, 'Operating Systems', 'Silberschatz', 'Wiley', 620);
INSERT INTO Library VALUES (3, 'Networking Basics', 'Forouzan', 'McGraw-Hill', 400);
COMMIT;


UPDATE Library
SET Price = 600
WHERE BookID = 1;


DELETE FROM Library
WHERE BookID = 2;

COMMIT;


SELECT * FROM Library_Audit;

SELECT * FROM Library;
